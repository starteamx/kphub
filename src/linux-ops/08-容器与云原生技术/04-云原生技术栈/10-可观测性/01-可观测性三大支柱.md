---
title: 可观测性三大支柱
icon: theory
order: 1
---

# 可观测性三大支柱

## 什么是可观测性

可观测性(Observability)源于控制理论，指通过系统的外部输出来推断系统内部状态的能力。在云原生环境中，可观测性是指通过收集和分析系统产生的数据，来了解系统行为、性能和健康状况的能力。

一个具有良好可观测性的系统能够回答以下问题：
- 系统现在是否正常运行？
- 用户体验如何？
- 出现问题时，问题出在哪里？
- 为什么会出现这个问题？

可观测性由三大支柱组成：监控(Metrics)、日志(Logs)和追踪(Traces)。这三大支柱相互补充，共同提供了全面了解系统状态的能力。

## 监控(Metrics)

### 概念与特点

监控是指对系统关键指标的数值测量，通常以时间序列数据的形式存在。监控数据具有以下特点：

1. **结构化**：监控数据通常是高度结构化的数值型数据
2. **低存储成本**：相比日志和追踪，监控数据占用存储空间较小
3. **聚合友好**：可以轻松进行数学运算和统计分析
4. **实时性强**：可以近实时地反映系统状态变化
5. **可视化友好**：易于绘制成图表，直观展示系统状态

### 常见监控指标类型

1. **计数器(Counter)**：单调递增的累计值，如请求总数、错误总数
   ```
   http_requests_total{method="GET", endpoint="/api/users"} 1234
   ```

2. **仪表盘(Gauge)**：可增可减的瞬时值，如内存使用量、CPU使用率
   ```
   memory_usage_bytes{instance="web-1"} 1024000000
   ```

3. **直方图(Histogram)**：对数据进行分桶统计，如请求延迟分布
   ```
   http_request_duration_seconds_bucket{le="0.1"} 12345
   http_request_duration_seconds_bucket{le="0.5"} 23456
   http_request_duration_seconds_bucket{le="1.0"} 34567
   ```

4. **摘要(Summary)**：类似直方图，但直接计算分位数
   ```
   http_request_duration_seconds{quantile="0.5"} 0.123
   http_request_duration_seconds{quantile="0.9"} 0.456
   http_request_duration_seconds{quantile="0.99"} 0.789
   ```

### 监控的四个黄金信号

Google SRE团队提出的四个黄金信号是监控系统健康状况的基础指标：

1. **延迟(Latency)**：服务响应请求所需的时间
2. **流量(Traffic)**：系统承受的需求量，如HTTP请求数、数据库查询数
3. **错误(Errors)**：失败请求的比率或数量
4. **饱和度(Saturation)**：系统资源的使用程度，如CPU、内存、磁盘I/O等

### 常见监控工具

1. **Prometheus**：开源的监控系统和时间序列数据库
2. **Grafana**：数据可视化和仪表盘工具
3. **Datadog**：SaaS监控平台
4. **Nagios/Zabbix**：传统监控工具
5. **云厂商监控服务**：如AWS CloudWatch、Azure Monitor、Google Cloud Monitoring

## 日志(Logs)

### 概念与特点

日志是系统在运行过程中产生的文本记录，详细记录了系统中发生的事件。日志具有以下特点：

1. **非结构化或半结构化**：通常是文本形式，可能包含结构化和非结构化部分
2. **存储成本高**：相比监控，日志数据量大，存储成本高
3. **详细性强**：包含丰富的上下文信息
4. **事件驱动**：记录离散的事件
5. **调试友好**：对问题排查和根因分析非常有用

### 日志级别

常见的日志级别从低到高依次为：

1. **TRACE**：最详细的日志级别，通常用于开发调试
2. **DEBUG**：调试信息，帮助开发人员理解程序执行流程
3. **INFO**：一般信息，记录应用正常运行时的状态变化
4. **WARN**：警告信息，表示可能的问题，但不影响系统正常运行
5. **ERROR**：错误信息，表示系统遇到了问题，但可以继续运行
6. **FATAL/CRITICAL**：致命错误，表示系统无法继续运行

### 结构化日志

结构化日志是指以结构化格式(如JSON)记录的日志，便于机器处理和分析。

```json
{
  "timestamp": "2023-05-15T08:12:34.567Z",
  "level": "ERROR",
  "logger": "com.example.service.UserService",
  "message": "Failed to authenticate user",
  "userId": "user123",
  "errorCode": "AUTH_FAILED",
  "stackTrace": "java.lang.Exception: Authentication failed\n\tat com.example..."
}
```

结构化日志的优势：
- 易于查询和过滤
- 便于自动化分析
- 支持复杂的聚合操作
- 更好的可视化支持

### 常见日志工具

1. **ELK/EFK Stack**：Elasticsearch(存储和搜索) + Logstash/Fluentd(收集和处理) + Kibana(可视化)
2. **Loki**：Grafana Labs开发的轻量级日志聚合系统
3. **Graylog**：开源日志管理平台
4. **Splunk**：商业日志分析平台
5. **云厂商日志服务**：如AWS CloudWatch Logs、Azure Log Analytics、Google Cloud Logging

## 追踪(Traces)

### 概念与特点

追踪是记录请求在分布式系统中的完整路径，展示请求如何在不同服务间流转。追踪具有以下特点：

1. **端到端可见性**：展示请求的完整生命周期
2. **因果关系明确**：清晰显示服务间的调用关系和依赖
3. **性能瓶颈识别**：帮助定位系统中的性能瓶颈
4. **复杂度高**：实现和维护相对复杂
5. **采样率权衡**：通常需要进行采样，平衡性能和数据完整性

### 追踪的核心概念

1. **Trace(追踪)**：表示一个请求的完整处理过程
2. **Span(跨度)**：表示一个操作单元，如一次RPC调用、数据库查询
3. **SpanContext(跨度上下文)**：包含追踪标识符和其他元数据，用于在服务间传递
4. **Baggage Items(行李项)**：随追踪一起传递的键值对，用于传递上下文信息

### 分布式追踪示例

下图展示了一个典型的分布式追踪视图：

```
Trace: 7be2a4f3a8f41d2c
┌─────────────────────────────────────────────────┐
│                  Frontend Service                │
│                                                 │
│  ┌──────────────────────────────────────────┐   │
│  │ /api/checkout (240ms)                     │   │
│  └───────────────┬──────────────────────────┘   │
└──────────────────┼──────────────────────────────┘
                   │
     ┌─────────────┼─────────────┐
     │             │             │
     ▼             ▼             ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│ User     │ │ Payment  │ │ Inventory│
│ Service  │ │ Service  │ │ Service  │
│ (50ms)   │ │ (150ms)  │ │ (40ms)   │
└──────────┘ └────┬─────┘ └──────────┘
                  │
                  ▼
             ┌──────────┐
             │ Database │
             │ (100ms)  │
             └──────────┘
```

### 常见追踪工具

1. **Jaeger**：由Uber开源的分布式追踪系统
2. **Zipkin**：由Twitter开源的分布式追踪系统
3. **OpenTelemetry**：开源的可观测性框架，统一了追踪、指标和日志
4. **Skywalking**：Apache开源的应用性能监控工具
5. **云厂商追踪服务**：如AWS X-Ray、Azure Application Insights、Google Cloud Trace

## 三大支柱的关系与集成

### 相互补充的关系

三大支柱各有优势，相互补充：

1. **监控**：提供系统整体状态的宏观视图，适合检测问题和告警
2. **日志**：提供详细的上下文信息，适合深入分析问题
3. **追踪**：提供请求的端到端视图，适合分析分布式系统中的问题

### 典型问题排查流程

1. **监控发现问题**：通过监控仪表盘或告警发现系统异常
2. **追踪定位范围**：使用追踪确定问题发生在哪些服务或组件
3. **日志分析根因**：查看相关服务的日志，分析问题根因

### 集成方案

现代可观测性平台通常会集成三大支柱，提供统一的体验：

1. **关联ID**：使用统一的请求ID或追踪ID关联监控、日志和追踪数据
2. **统一数据模型**：如OpenTelemetry提供的统一数据模型
3. **上下文传播**：在服务间传递上下文信息，确保可观测性数据的连贯性
4. **统一可视化**：在同一界面展示监控、日志和追踪数据

```
┌─────────────────────────────────────────────────────────┐
│                  统一可观测性平台                        │
│                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │             │    │             │    │             │  │
│  │    监控     │◄───┼───►  日志   │◄───┼───►  追踪   │  │
│  │  (Metrics)  │    │   (Logs)   │    │  (Traces)  │  │
│  │             │    │             │    │             │  │
│  └─────────────┘    └─────────────┘    └─────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │                                                 │    │
│  │              统一数据模型和存储                  │    │
│  │                                                 │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 实现统一可观测性的工具

1. **OpenTelemetry**：提供统一的API和SDK，支持收集和导出监控、日志和追踪数据
2. **Elastic Stack**：通过Elasticsearch、Kibana、APM等组件提供统一的可观测性解决方案
3. **Grafana Labs生态**：Grafana(可视化) + Prometheus(监控) + Loki(日志) + Tempo(追踪)
4. **商业平台**：如Datadog、New Relic、Dynatrace等
5. **云厂商解决方案**：如AWS CloudWatch、Azure Monitor、Google Cloud Operations

## 构建可观测性文化

技术工具只是可观测性的一部分，构建可观测性文化同样重要：

1. **设计阶段考虑可观测性**：在系统设计阶段就考虑如何实现可观测性
2. **标准化实践**：制定统一的监控、日志和追踪标准
3. **自助服务能力**：让开发团队能够自主配置和使用可观测性工具
4. **持续改进**：根据实际使用情况不断优化可观测性实践
5. **知识共享**：分享可观测性最佳实践和经验教训

## 总结

可观测性的三大支柱——监控、日志和追踪，共同构成了现代云原生系统的可观测性基础。它们各有优势，相互补充，共同提供了全面了解系统状态的能力。

- **监控**提供系统整体状态的宏观视图
- **日志**提供详细的上下文信息
- **追踪**提供请求的端到端视图

通过集成这三大支柱，并构建可观测性文化，组织可以更有效地监控系统健康状况、排查问题、优化性能，最终提供更可靠的服务和更好的用户体验。

随着云原生技术的发展，可观测性领域也在不断创新，如eBPF技术、AI辅助分析等新技术正在改变可观测性的实践方式。保持对这些新技术和最佳实践的关注，将有助于持续提升系统的可观测性能力。