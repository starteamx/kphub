---
title: 搜索与替换技巧
icon: search
order: 5
---

# 搜索与替换技巧

## 基础搜索命令

Vim 提供了强大而灵活的搜索功能，掌握这些基础命令是高效编辑的第一步。

### 基本搜索操作

在 Vim 中，最基本的搜索命令是 `/` 和 `?`：

| 命令 | 功能 |
|------|------|
| `/pattern` | 向前（向下）搜索 pattern |
| `?pattern` | 向后（向上）搜索 pattern |
| `n` | 重复上次搜索（同方向） |
| `N` | 重复上次搜索（反方向） |

使用这些命令的基本流程是：

1. 在普通模式下，输入 `/` 或 `?` 进入命令行模式
2. 输入要搜索的文本或模式
3. 按 `Enter` 执行搜索
4. 使用 `n` 或 `N` 在匹配项之间导航

例如，要搜索单词 "example"：

```
/example
```

执行搜索后，光标会跳转到文档中第一个匹配的位置。然后可以使用 `n` 查找下一个匹配项，或使用 `N` 查找上一个匹配项。

### 快速单词搜索

Vim 提供了快速搜索光标下单词的快捷方式：

| 命令 | 功能 |
|------|------|
| `*` | 向前搜索光标下的完整单词 |
| `#` | 向后搜索光标下的完整单词 |
| `g*` | 向前搜索光标下的单词（部分匹配） |
| `g#` | 向后搜索光标下的单词（部分匹配） |

这些命令特别有用，因为它们不需要你手动输入搜索文本。例如，将光标放在单词 "function" 上并按 `*`，Vim 会立即搜索下一个 "function" 单词。

`*` 和 `#` 搜索完整单词，这意味着它们只匹配独立的单词。例如，搜索 "cat" 不会匹配 "category"。而 `g*` 和 `g#` 则允许部分匹配，所以搜索 "cat" 也会匹配 "category"。

### 搜索历史

Vim 会记住你之前的搜索，你可以通过命令行模式访问这些历史记录：

1. 按 `/` 或 `?` 进入搜索模式
2. 使用 `↑` 和 `↓` 箭头键浏览之前的搜索
3. 按 `Enter` 执行选中的搜索，或编辑后再执行

你也可以使用 `:history /` 命令查看完整的搜索历史。

### 搜索设置

Vim 提供了几个影响搜索行为的设置：

| 设置 | 功能 | 命令 |
|------|------|------|
| `ignorecase` | 搜索时忽略大小写 | `:set ignorecase` |
| `smartcase` | 如果搜索模式包含大写字母，则区分大小写 | `:set smartcase` |
| `hlsearch` | 高亮显示所有匹配项 | `:set hlsearch` |
| `incsearch` | 增量搜索（输入时实时显示匹配） | `:set incsearch` |
| `wrapscan` | 搜索到文件末尾时回到开头 | `:set wrapscan` |

这些设置可以组合使用。例如，同时启用 `ignorecase` 和 `smartcase` 是一个常见的配置，它允许你在大多数情况下进行不区分大小写的搜索，但当你输入大写字母时会自动切换到区分大小写的搜索。

要临时关闭搜索高亮，可以使用：

```
:nohlsearch
```

或者使用快捷命令（通常映射为 `<Leader>h` 或类似键）：

```
:noh
```

## 增量搜索

增量搜索是 Vim 的一个强大功能，它允许你在输入搜索模式时实时看到匹配结果。

### 启用增量搜索

要启用增量搜索，使用以下命令：

```
:set incsearch
```

启用后，当你输入 `/pattern` 时，Vim 会在你输入每个字符后立即显示第一个匹配项。这使得搜索更加交互式和直观。

### 增量搜索的优势

1. **即时反馈**：立即看到搜索结果，无需完成整个模式输入
2. **模式调整**：可以根据匹配结果调整搜索模式
3. **减少击键次数**：找到目标后可以立即停止输入

### 增量搜索导航

在增量搜索过程中，你可以使用以下快捷键：

| 命令 | 功能 |
|------|------|
| `Ctrl+g` | 移动到下一个匹配项（不完成搜索） |
| `Ctrl+t` | 移动到上一个匹配项（不完成搜索） |
| `Enter` | 完成搜索并将光标留在当前匹配项 |
| `Esc` | 取消搜索并返回到起始位置 |

这些导航命令使增量搜索更加灵活，允许你在完成搜索之前预览多个匹配项。

## 正则表达式搜索

Vim 支持强大的正则表达式搜索，允许你创建复杂的搜索模式。

### Vim 正则表达式基础

Vim 的正则表达式语法与标准正则表达式略有不同。以下是一些基本元素：

| 元素 | 描述 | 示例 |
|------|------|------|
| `.` | 匹配任意单个字符 | `/a.c` 匹配 "abc", "adc" 等 |
| `*` | 匹配前一个字符零次或多次 | `/ab*c` 匹配 "ac", "abc", "abbc" 等 |
| `\+` | 匹配前一个字符一次或多次 | `/ab\+c` 匹配 "abc", "abbc" 等，但不匹配 "ac" |
| `\?` | 匹配前一个字符零次或一次 | `/ab\?c` 匹配 "ac" 和 "abc" |
| `\{n,m\}` | 匹配前一个字符 n 到 m 次 | `/a\{2,4\}` 匹配 "aa", "aaa", "aaaa" |
| `[]` | 字符类，匹配括号内的任意字符 | `/[abc]` 匹配 "a", "b", 或 "c" |
| `[^]` | 否定字符类，匹配不在括号内的任意字符 | `/[^abc]` 匹配除 "a", "b", "c" 外的任何字符 |
| `\|` | 交替，匹配 \| 两边的任一表达式 | `/foo\|bar` 匹配 "foo" 或 "bar" |
| `\(\)` | 分组，创建一个子模式 | `/\(foo\)\+` 匹配 "foo", "foofoo" 等 |
| `^` | 匹配行首 | `/^The` 匹配以 "The" 开头的行 |
| `$` | 匹配行尾 | `/end$` 匹配以 "end" 结尾的行 |
| `\<` | 匹配单词开头 | `/\<the` 匹配以 "the" 开头的单词 |
| `\>` | 匹配单词结尾 | `/the\>` 匹配以 "the" 结尾的单词 |
| `\w` | 匹配单词字符（字母、数字、下划线） | `/\w\+` 匹配一个或多个单词字符 |
| `\W` | 匹配非单词字符 | `/\W\+` 匹配一个或多个非单词字符 |
| `\s` | 匹配空白字符（空格、制表符等） | `/a\sb` 匹配 "a" 和 "b" 之间有空白字符 |
| `\S` | 匹配非空白字符 | `/\S\+` 匹配一个或多个非空白字符 |

### 正则表达式搜索示例

以下是一些常用的正则表达式搜索示例：

1. **搜索完整单词**：
   ```
   /\<word\>
   ```

2. **搜索以特定文本开头的行**：
   ```
   /^function
   ```

3. **搜索以特定文本结尾的行**：
   ```
   /;$
   ```

4. **搜索空行**：
   ```
   /^$
   ```

5. **搜索包含特定模式的行**：
   ```
   /function.*return
   ```

6. **搜索 HTML 标签**：
   ```
   /<[^>]\+>
   ```

7. **搜索电子邮件地址**：
   ```
   /\<[A-Za-z0-9._%+-]\+@[A-Za-z0-9.-]\+\.[A-Za-z]\{2,\}\>
   ```

### 魔术模式（Magic Mode）

Vim 的正则表达式有四种"魔术"级别，它们决定了哪些字符具有特殊含义：

1. **`nomagic`**：几乎所有字符都按字面意义匹配
2. **`magic`**：默认设置，部分字符有特殊含义
3. **`very magic`**：大多数字符有特殊含义
4. **`very nomagic`**：几乎所有字符都按字面意义匹配

你可以在搜索模式中使用以下前缀来切换魔术模式：

| 前缀 | 模式 | 示例 |
|------|------|------|
| `\m` | magic（默认） | `/\mpattern` |
| `\M` | nomagic | `/\Mpattern` |
| `\v` | very magic | `/\vpattern` |
| `\V` | very nomagic | `/\Vpattern` |

在 `very magic` 模式下，你可以使用更接近标准正则表达式的语法：

```
/\v(foo|bar)+
```

而在默认的 `magic` 模式下，相同的模式需要更多的转义：

```
/\(foo\|bar\)\+
```

`very nomagic` 模式对于搜索包含许多特殊字符的文本特别有用：

```
/\V[example].txt
```

这会按字面意义搜索 "[example].txt"，而不将 `[` 和 `.` 解释为正则表达式元字符。

## 多文件搜索

Vim 提供了多种在多个文件中搜索的方法。

### 使用 :vimgrep

`:vimgrep` 命令允许你在多个文件中搜索模式：

```
:vimgrep /pattern/ file1 file2 ...
:vimgrep /pattern/ **/*.txt
```

搜索结果会填充到"快速修复列表"（quickfix list）中，你可以使用以下命令导航：

| 命令 | 功能 |
|------|------|
| `:copen` | 打开快速修复窗口 |
| `:cnext` 或 `:cn` | 跳转到下一个匹配项 |
| `:cprevious` 或 `:cp` | 跳转到上一个匹配项 |
| `:cfirst` 或 `:cfir` | 跳转到第一个匹配项 |
| `:clast` 或 `:cla` | 跳转到最后一个匹配项 |
| `:cclose` 或 `:ccl` | 关闭快速修复窗口 |

### 使用外部工具

Vim 可以与外部搜索工具集成，如 `grep`、`ag`（The Silver Searcher）或 `ripgrep`：

```
:grep pattern files
:grep -r pattern directory
```

与 `:vimgrep` 类似，结果会填充到快速修复列表中。

要使用 `ag` 或 `ripgrep` 等替代工具，你可以设置 `grepprg` 选项：

```
:set grepprg=ag\ --vimgrep
:set grepprg=rg\ --vimgrep
```

### 使用插件

多个 Vim 插件提供了增强的多文件搜索功能：

1. **fzf.vim**：提供模糊搜索功能
2. **CtrlP**：文件和缓冲区模糊查找器
3. **ack.vim**：集成 ack 搜索工具
4. **NERDTree**：文件浏览器，支持文件搜索

这些插件通常提供更快的搜索速度和更好的用户界面。

## 基本替换命令

Vim 的替换功能通过 `:substitute` 命令（简写为 `:s`）实现。

### 基本语法

替换命令的基本语法是：

```
:[range]s/{pattern}/{replacement}/[flags]
```

其中：
- `[range]` 是可选的行范围
- `{pattern}` 是要搜索的模式
- `{replacement}` 是替换文本
- `[flags]` 是可选的标志，控制替换行为

### 常用范围

| 范围 | 描述 |
|------|------|
| 无范围 | 仅当前行 |
| `.` | 当前行 |
| `$` | 最后一行 |
| `%` | 整个文件（等同于 `1,$`） |
| `'<,'>` | 可视模式选择的行（在可视模式下按 `:` 时自动添加） |
| `n,m` | 第 n 行到第 m 行 |
| `.+n` | 当前行后的第 n 行 |
| `.-n` | 当前行前的第 n 行 |
| `/pattern/,/pattern/` | 两个模式之间的行 |

### 常用标志

| 标志 | 描述 |
|------|------|
| `g` | 全局替换（替换行内所有匹配项，而不仅是第一个） |
| `c` | 确认每次替换 |
| `i` | 忽略大小写 |
| `I` | 不忽略大小写 |
| `n` | 只报告匹配次数，不实际替换 |

### 基本替换示例

1. **替换当前行中的第一个匹配项**：
   ```
   :s/old/new/
   ```

2. **替换当前行中的所有匹配项**：
   ```
   :s/old/new/g
   ```

3. **替换整个文件中的所有匹配项**：
   ```
   :%s/old/new/g
   ```

4. **在第 5 行到第 20 行之间替换**：
   ```
   :5,20s/old/new/g
   ```

5. **在可视模式选择的行中替换**：
   选择文本后按 `:` 然后输入：
   ```
   s/old/new/g
   ```

6. **替换时确认每次更改**：
   ```
   :%s/old/new/gc
   ```

## 高级替换技巧

### 使用正则表达式替换

Vim 的替换命令支持正则表达式，使替换操作更加强大：

1. **替换单词边界**：
   ```
   :%s/\<old\>/new/g
   ```
   这只会替换完整的单词 "old"，而不会替换 "folder" 中的 "old"。

2. **使用分组和反向引用**：
   ```
   :%s/\(\w\+\) \(\w\+\)/\2 \1/g
   ```
   这会交换每对单词的顺序，例如 "hello world" 变为 "world hello"。

3. **条件替换**：
   ```
   :%s/\(pattern\)\@<=text/replacement/g
   ```
   这只替换在 "pattern" 之后的 "text"。

### 替换中的特殊字符

在替换文本中，某些字符有特殊含义：

| 字符 | 含义 |
|------|------|
| `\1`, `\2`, ... | 引用模式中的第 1, 2, ... 个分组 |
| `&` 或 `\0` | 引用整个匹配文本 |
| `\u` | 将下一个字符转为大写 |
| `\U` | 将后面的字符转为大写，直到 `\E` |
| `\l` | 将下一个字符转为小写 |
| `\L` | 将后面的字符转为小写，直到 `\E` |
| `\E` | 结束 `\U` 或 `\L` |
| `\r` | 插入换行符 |
| `\n` | 插入空字符（在替换文本中通常表示换行） |
| `\t` | 插入制表符 |
| `\\` | 插入反斜杠 |
| `\&` | 插入 & 字符 |

### 替换示例

1. **将驼峰命名转换为下划线命名**：
   ```
   :%s/\<\(\w\)\(\w*\)\>/\l\1\L\2/g
   :%s/\([A-Z]\)/\_\l\1/g
   ```

2. **HTML 标签转换**：
   ```
   :%s/<\([^>]*\)>/[\1]/g
   ```
   这会将 `<tag>` 转换为 `[tag]`。

3. **添加行号**：
   ```
   :%s/^/\=line('.') . ': '/
   ```
   这会在每行前添加行号。

4. **删除行尾空白**：
   ```
   :%s/\s\+$//
   ```

5. **将制表符转换为空格**：
   ```
   :%s/\t/    /g
   ```

### 使用表达式替换

Vim 允许使用 `\=` 在替换中执行表达式：

```
:%s/\d\+/\=submatch(0) * 2/g
```

这会将所有数字乘以 2。

更复杂的例子：

```
:%s/\(\d\+\)/\=str2nr(submatch(1)) + 10/g
```

这会将所有数字加 10。

## 交互式替换

交互式替换允许你在执行替换操作时逐个确认更改。

### 使用 'c' 标志

添加 `c` 标志会使 Vim 在每次替换前请求确认：

```
:%s/old/new/gc
```

当 Vim 请求确认时，你可以使用以下响应：

| 响应 | 动作 |
|------|------|
| `y` | 替换这个匹配 |
| `n` | 跳过这个匹配 |
| `a` | 替换这个和所有剩余的匹配 |
| `q` 或 `Esc` | 退出替换 |
| `l` | 替换这个匹配并退出（"last"） |
| `Ctrl+e` | 向上滚动 |
| `Ctrl+y` | 向下滚动 |

### 使用预览窗口

在 Neovim 和较新版本的 Vim 中，你可以使用 `inccommand` 选项预览替换结果：

```
:set inccommand=split
```

或者只在当前行显示预览：

```
:set inccommand=nosplit
```

启用后，当你输入替换命令时，Vim 会实时显示更改的预览。

## 多文件替换

### 使用 :argdo

`:argdo` 命令允许你在参数列表中的所有文件上执行命令：

```
:args *.txt
:argdo %s/old/new/ge | update
```

这会在所有 .txt 文件中替换 "old" 为 "new"，并保存更改。`e` 标志会忽略错误，允许命令在没有匹配的文件中继续执行。

### 使用 :bufdo

`:bufdo` 命令在所有缓冲区上执行命令：

```
:bufdo %s/old/new/ge | update
```

这会在所有打开的缓冲区中执行替换。

### 使用 :windo

`:windo` 命令在所有窗口上执行命令：

```
:windo %s/old/new/ge | update
```

这会在所有可见窗口中执行替换。

### 使用 :cdo

`:cdo` 命令在快速修复列表中的每个条目上执行命令：

```
:grep "old" *.txt
:cdo s/old/new/g | update
```

这会先使用 grep 查找所有包含 "old" 的文件，然后在这些位置执行替换。

## 实用搜索与替换场景

### 代码重构

1. **重命名变量**：
   ```
   :%s/\<oldVar\>/newVar/g
   ```

2. **更改函数签名**：
   ```
   :%s/function oldName(/function newName(/g
   ```

3. **添加函数参数**：
   ```
   :%s/function \(\w\+\)(/function \1(newParam, /g
   ```

### 文本格式化

1. **将多个空行合并为一个**：
   ```
   :%s/\n\{3,}/\r\r/g
   ```

2. **将空格缩进转换为制表符**：
   ```
   :%s/^\( \{4\}\)\+/\=repeat('\t', len(submatch(0)) / 4)/g
   ```

3. **将 Windows 行尾转换为 Unix 行尾**：
   ```
   :%s/\r\n/\r/g
   ```

### 数据处理

1. **提取电子邮件地址**：
   ```
   :%s/.*\(\<[A-Za-z0-9._%+-]\+@[A-Za-z0-9.-]\+\.[A-Za-z]\{2,\}\>\).*/\1/g
   ```

2. **格式化 CSV 数据**：
   ```
   :%s/,/,\t/g
   ```

3. **将无序列表转换为有序列表**：
   ```
   :%s/^- /\=line('.') - line("'<") + 1 . '. '/
   ```

### HTML/XML 处理

1. **删除 HTML 标签**：
   ```
   :%s/<[^>]\+>//g
   ```

2. **更改 HTML 属性**：
   ```
   :%s/<a href=\([^ >]\+\)>/<a target="_blank" href=\1>/g
   ```

3. **格式化 XML**：
   ```
   :%!xmllint --format -
   ```

## 搜索与替换的最佳实践

### 增量开发复杂模式

开发复杂的搜索或替换模式时：

1. 从简单模式开始，逐步添加复杂性
2. 使用 `:set hlsearch` 和 `/pattern` 测试搜索模式
3. 使用 `:%s/pattern/pattern/n` 计算匹配数而不实际替换
4. 在小范围上测试替换（如 `:1,10s/pattern/replacement/g`）
5. 成功后再应用到整个文件

### 使用寄存器和宏

1. **使用寄存器存储复杂模式**：
   ```
   :let @a = 'complex_pattern'
   :%s/<C-r>a/replacement/g
   ```
   按 `Ctrl+r` 然后 `a` 插入寄存器 a 的内容。

2. **使用宏自动化重复的搜索替换**：
   ```
   qa                     " 开始录制宏到寄存器 a
   /pattern<Enter>        " 搜索模式
   cgnnew_text<Esc>       " 更改匹配并移动到下一个
   q                      " 结束录制
   @a                     " 执行宏
   ```

### 备份和安全措施

1. **在执行大规模替换前保存文件**：
   ```
   :w backup_file.txt
   ```

2. **使用 undofile 功能**：
   ```
   :set undofile
   :set undodir=~/.vim/undodir
   ```
   这允许你在关闭并重新打开文件后仍然可以撤销更改。

3. **使用版本控制**：在对代码库进行大规模更改前提交当前状态。

## 高级搜索与替换插件

### 增强搜索插件

1. **vim-easymotion**：提供快速导航到搜索结果的视觉提示
2. **incsearch.vim**：增强的增量搜索
3. **vim-anzu**：显示搜索状态（当前匹配/总匹配数）

### 增强替换插件

1. **vim-abolish**：智能替换，处理大小写和单复数形式
2. **vim-multiple-cursors** 或 **vim-visual-multi**：类似 Sublime Text 的多光标编辑
3. **vim-grepper**：集成多种搜索工具的界面

### 模糊查找插件

1. **fzf.vim**：模糊查找文件、缓冲区、行等
2. **CtrlP**：模糊文件查找器
3. **telescope.nvim**（Neovim）：高度可定制的模糊查找框架

## 总结

Vim 的搜索和替换功能是其最强大的特性之一，掌握这些技巧可以显著提高文本编辑效率。关键要点包括：

1. **基础搜索**：使用 `/` 和 `?` 命令，以及 `*` 和 `#` 快速搜索光标下的单词
2. **正则表达式**：利用 Vim 的正则表达式语法创建复杂的搜索模式
3. **多文件搜索**：使用 `:vimgrep`、`:grep` 或专门的插件在多个文件中搜索
4. **基本替换**：使用 `:s` 命令进行简单替换
5. **高级替换**：利用正则表达式、分组和反向引用进行复杂替换
6. **交互式替换**：使用 `c` 标志或 `inccommand` 选项进行交互式替换
7. **多文件替换**：使用 `:argdo`、`:bufdo`、`:windo` 或 `:cdo` 在多个文件中执行替换

通过系统地学习和实践这些技巧，你可以将 Vim 转变为一个强大的文本处理工具，能够高效地处理从简单文本编辑到复杂代码重构的各种任务。

记住，Vim 的学习曲线可能很陡，但投入的时间将获得丰厚的回报，因为这些技能可以在你的整个编程或写作生涯中使用。从简单的搜索和替换开始，逐步掌握更